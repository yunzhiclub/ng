import { HttpRequest, HttpResponseBase } from '@angular/common/http';
import { Observable } from 'rxjs';
import { isNotNullOrUndefined } from './utils';
/**
 * 模拟API
 */
export class MockApiService {
    /**
     * 循环调用从而完成所有的接口注册
     */
    constructor(delayHandler) {
        this.delayHandler = delayHandler;
        /**
         * 路由信息
         * Record<请求方法, Record<请求地址（正则表达式）, 回调函数<模拟返回的实体类型>>>
         */
        this.routers = {};
    }
    static getMockApiService(mockObservable) {
        return new MockApiService(mockObservable);
    }
    /**
     * 注册模拟接口
     * @param classes 接口类型
     */
    registerMockApis(classes) {
        classes.forEach(clazz => {
            const instance = new clazz();
            const injectors = instance.getInjectors();
            injectors.forEach(injector => {
                this.registerMockApi(injector.method, injector.url, injector.result);
            });
        });
    }
    /**
     * 注册模拟接口
     * @param method 请求方法
     * @param url 请求地址
     * @param handlerOrResult 获取数据源方法
     */
    registerMockApi(method, url, handlerOrResult) {
        if (method === null || method === undefined) {
            method = 'GET';
        }
        if (undefined === this.routers[method] || null === this.routers[method]) {
            this.routers[method] = {};
        }
        if (isNotNullOrUndefined(this.routers[method][url])) {
            throw Error(`在地址${url}已存在${method}的路由记录`);
        }
        this.routers[method][url] = handlerOrResult;
    }
    request(arg0, ...args) {
        // 初化始信息
        let url;
        let options;
        let method;
        // 根据请求参数类型,初始化请求基本信息
        if (arg0 instanceof HttpRequest) {
            method = arg0.method.toUpperCase();
            url = arg0.url;
            options = {
                body: arg0.body,
                headers: arg0.headers,
                reportProgress: arg0.reportProgress,
                observe: 'body',
                params: arg0.params,
                responseType: arg0.responseType,
                withCredentials: arg0.withCredentials
            };
        }
        else {
            method = arg0;
            url = args[0];
            options = args[1];
        }
        // 根据请求数据,查找注册的API
        const keys = [];
        let requestHandler = null;
        let urlMatches = undefined;
        const urlRecord = this.routers[method];
        for (const key in urlRecord) {
            if (urlRecord.hasOwnProperty(key)) {
                const reg = new RegExp(`^${key}$`);
                if (reg.test(url)) {
                    urlMatches = url.match(reg);
                    requestHandler = urlRecord[key];
                    keys.push(key);
                    if (keys.length > 1) {
                        const message = 'yzMockApi Error: conflict, matched multiple routes';
                        console.error(message, method, url, keys);
                        return new Observable(subscriber => {
                            this.delayHandler.error(message, subscriber);
                        });
                    }
                }
            }
        }
        // 未找到API则报错
        if (keys.length === 0) {
            return new Observable(subscriber => {
                const message = `yzMockApi Error: can't find mock result data: \n` +
                    `1. pls make sure the request's url '${url}' and method '${method}' is right. \n` +
                    `2. pls make sure your mockApi file has been added to the module HttpInterceptor.`;
                console.error(message);
                this.delayHandler.error(message, subscriber);
            });
        }
        // requestHandler可能是回调,也可能是返回值.在此做类型的判断.
        let result = null;
        if (typeof requestHandler === 'function') {
            requestHandler = requestHandler;
            result = requestHandler(urlMatches, options);
        }
        else {
            requestHandler = requestHandler;
            result = requestHandler;
        }
        // 按最终结果的类型分别返回
        if (result instanceof Observable) {
            return result;
        }
        else if (result instanceof HttpResponseBase) {
            return new Observable(ob => {
                ob.next(result);
                ob.complete();
            });
        }
        else {
            // 一般数据时加入延时
            return new Observable(observable1 => {
                this.delayHandler.next(result, observable1);
            });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9jay1hcGkuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL21vY2stYXBpL3NyYy9saWIvbW9jay1hcGkuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBSU8sV0FBVyxFQUFFLGdCQUFnQixFQUMxQyxNQUFNLHNCQUFzQixDQUFDO0FBQzlCLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFHaEMsT0FBTyxFQUFDLG9CQUFvQixFQUFDLE1BQU0sU0FBUyxDQUFDO0FBSTdDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLGNBQWM7SUEwQnpCOztPQUVHO0lBQ0gsWUFBNEIsWUFBbUM7UUFBbkMsaUJBQVksR0FBWixZQUFZLENBQXVCO1FBNUIvRDs7O1dBR0c7UUFDSCxZQUFPLEdBQUcsRUFBdUUsQ0FBQztJQXlCbEYsQ0FBQztJQXZCTSxNQUFNLENBQUMsaUJBQWlCLENBQUMsY0FBcUM7UUFDbkUsT0FBTyxJQUFJLGNBQWMsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBR0Q7OztPQUdHO0lBQ0gsZ0JBQWdCLENBQUMsT0FBaUM7UUFDaEQsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUN0QixNQUFNLFFBQVEsR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO1lBQzdCLE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUMxQyxTQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUMzQixJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDdkUsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFRRDs7Ozs7T0FLRztJQUNILGVBQWUsQ0FBSSxNQUF5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aEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQzlDLENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBIdHRwRXJyb3JSZXNwb25zZSxcbiAgSHR0cEV2ZW50LFxuICBIdHRwSGVhZGVycyxcbiAgSHR0cFBhcmFtcywgSHR0cFJlcXVlc3QsIEh0dHBSZXNwb25zZUJhc2Vcbn0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tICdyeGpzJztcbmltcG9ydCB7VHlwZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge01vY2tBcGlJbnRlcmZhY2V9IGZyb20gJy4vbW9jay1hcGkuaW50ZXJmYWNlJztcbmltcG9ydCB7aXNOb3ROdWxsT3JVbmRlZmluZWR9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHtEZWxheUhhbmRsZXJJbnRlcmZhY2V9IGZyb20gJy4vZGVsYXktaGFuZGxlci5pbnRlcmZhY2UnO1xuaW1wb3J0IHtSZXF1ZXN0SGFuZGxlciwgUmVxdWVzdE1ldGhvZFR5cGV9IGZyb20gJy4vbW9jay1hcGkudHlwZXMnO1xuXG4vKipcbiAqIOaooeaLn0FQSVxuICovXG5leHBvcnQgY2xhc3MgTW9ja0FwaVNlcnZpY2Uge1xuICAvKipcbiAgICog6Lev55Sx5L+h5oGvXG4gICAqIFJlY29yZDzor7fmsYLmlrnms5UsIFJlY29yZDzor7fmsYLlnLDlnYDvvIjmraPliJnooajovr7lvI/vvIksIOWbnuiwg+WHveaVsDzmqKHmi5/ov5Tlm57nmoTlrp7kvZPnsbvlnos+Pj5cbiAgICovXG4gIHJvdXRlcnMgPSB7fSBhcyBSZWNvcmQ8UmVxdWVzdE1ldGhvZFR5cGUsIFJlY29yZDxhbnksIGFueSB8IFJlcXVlc3RIYW5kbGVyPGFueT4+PjtcblxuICBwdWJsaWMgc3RhdGljIGdldE1vY2tBcGlTZXJ2aWNlKG1vY2tPYnNlcnZhYmxlOiBEZWxheUhhbmRsZXJJbnRlcmZhY2UpOiBNb2NrQXBpU2VydmljZSB7XG4gICAgcmV0dXJuIG5ldyBNb2NrQXBpU2VydmljZShtb2NrT2JzZXJ2YWJsZSk7XG4gIH1cblxuXG4gIC8qKlxuICAgKiDms6jlhozmqKHmi5/mjqXlj6NcbiAgICogQHBhcmFtIGNsYXNzZXMg5o6l5Y+j57G75Z6LXG4gICAqL1xuICByZWdpc3Rlck1vY2tBcGlzKGNsYXNzZXM6IFR5cGU8TW9ja0FwaUludGVyZmFjZT5bXSk6IHZvaWQge1xuICAgIGNsYXNzZXMuZm9yRWFjaChjbGF6eiA9PiB7XG4gICAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBjbGF6eigpO1xuICAgICAgY29uc3QgaW5qZWN0b3JzID0gaW5zdGFuY2UuZ2V0SW5qZWN0b3JzKCk7XG4gICAgICBpbmplY3RvcnMuZm9yRWFjaChpbmplY3RvciA9PiB7XG4gICAgICAgIHRoaXMucmVnaXN0ZXJNb2NrQXBpKGluamVjdG9yLm1ldGhvZCwgaW5qZWN0b3IudXJsLCBpbmplY3Rvci5yZXN1bHQpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICog5b6q546v6LCD55So5LuO6ICM5a6M5oiQ5omA5pyJ55qE5o6l5Y+j5rOo5YaMXG4gICAqL1xuICBwcml2YXRlIGNvbnN0cnVjdG9yKHByaXZhdGUgZGVsYXlIYW5kbGVyOiBEZWxheUhhbmRsZXJJbnRlcmZhY2UpIHtcbiAgfVxuXG4gIC8qKlxuICAgKiDms6jlhozmqKHmi5/mjqXlj6NcbiAgICogQHBhcmFtIG1ldGhvZCDor7fmsYLmlrnms5VcbiAgICogQHBhcmFtIHVybCDor7fmsYLlnLDlnYBcbiAgICogQHBhcmFtIGhhbmRsZXJPclJlc3VsdCDojrflj5bmlbDmja7mupDmlrnms5VcbiAgICovXG4gIHJlZ2lzdGVyTW9ja0FwaTxUPihtZXRob2Q6IFJlcXVlc3RNZXRob2RUeXBlLFxuICAgICAgICAgICAgICAgICAgICAgdXJsOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICBoYW5kbGVyT3JSZXN1bHQ6IFQgfCBSZXF1ZXN0SGFuZGxlcjxUPik6IHZvaWQge1xuICAgIGlmIChtZXRob2QgPT09IG51bGwgfHwgbWV0aG9kID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG1ldGhvZCA9ICdHRVQnO1xuICAgIH1cbiAgICBpZiAodW5kZWZpbmVkID09PSB0aGlzLnJvdXRlcnNbbWV0aG9kXSB8fCBudWxsID09PSB0aGlzLnJvdXRlcnNbbWV0aG9kXSkge1xuICAgICAgdGhpcy5yb3V0ZXJzW21ldGhvZF0gPSB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBSZXF1ZXN0SGFuZGxlcjxUPj47XG4gICAgfVxuXG4gICAgaWYgKGlzTm90TnVsbE9yVW5kZWZpbmVkKHRoaXMucm91dGVyc1ttZXRob2RdW3VybF0pKSB7XG4gICAgICB0aHJvdyBFcnJvcihg5Zyo5Zyw5Z2AJHt1cmx95bey5a2Y5ZyoJHttZXRob2R955qE6Lev55Sx6K6w5b2VYCk7XG4gICAgfVxuXG4gICAgdGhpcy5yb3V0ZXJzW21ldGhvZF1bdXJsXSA9IGhhbmRsZXJPclJlc3VsdDtcbiAgfVxuXG4gIHJlcXVlc3Q8Uj4ocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IE9ic2VydmFibGU8SHR0cEV2ZW50PFI+PjtcbiAgLyoqXG4gICAqIOaJgOacieeahEdFVFxcUE9TVFxcREVMRVRFXFxQVVRcXFBBVENI5pa55rOV5pyA57uI5Z2H6LCD55SocmVxdWVzdOaWueazleOAglxuICAgKiDlpoLmnpzlvZPliY1yZXF1ZXN05LiN6IO95aSf5ruh6Laz6ZyA5rGC77yM5YiZ6K+356e75q2lYW5ndWxhcuWumOaWueaPkOS+m+eahEh0dHBDbGllbnRcbiAgICpcbiAgICog6K+l5pa55rOV5YWI5qC55o2ubWV0aG9k6L+b6KGM5Yy56YWN77yM5o6l552A5qC55o2uVVJM6L+b6KGM5q2j5YiZ6KGo6L6+5byP55qE5Yy56YWN44CCXG4gICAqIOWMuemFjeaIkOWKn+WQjuWwhuWPguaVsOS8oOWFpeaOpeWPo+W5tuiOt+WPluaooeaLn+aOpeWPo+eahOi/lOWbnuWAvFxuICAgKlxuICAgKiBAcGFyYW0gbWV0aG9kIOivt+axguaWueazlVxuICAgKiBAcGFyYW0gdXJsIOivt+axguWcsOWdgFxuICAgKiBAcGFyYW0gb3B0aW9ucyDpgInpoblcbiAgICovXG4gIHJlcXVlc3Q8Uj4obWV0aG9kOiBzdHJpbmcsIHVybDogc3RyaW5nLCBvcHRpb25zOiB7XG4gICAgYm9keT86IGFueTtcbiAgICBoZWFkZXJzPzogSHR0cEhlYWRlcnMgfCB7XG4gICAgICBbaGVhZGVyOiBzdHJpbmddOiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgICB9O1xuICAgIHJlcG9ydFByb2dyZXNzPzogYm9vbGVhbjtcbiAgICBvYnNlcnZlOiAnYm9keSc7XG4gICAgcGFyYW1zPzogSHR0cFBhcmFtcyB8IHtcbiAgICAgIFtwYXJhbTogc3RyaW5nXTogc3RyaW5nIHwgc3RyaW5nW107XG4gICAgfTtcbiAgICByZXNwb25zZVR5cGU/OiAnanNvbic7XG4gICAgd2l0aENyZWRlbnRpYWxzPzogYm9vbGVhbjtcbiAgfSk6IE9ic2VydmFibGU8Uj47XG4gIHJlcXVlc3Q8Uj4oYXJnMDogYW55LCAuLi5hcmdzOiBhbnlbXSk6IGFueSB7XG4gICAgLy8g5Yid5YyW5aeL5L+h5oGvXG4gICAgbGV0IHVybDogc3RyaW5nO1xuICAgIGxldCBvcHRpb25zOiB7XG4gICAgICBib2R5PzogYW55O1xuICAgICAgaGVhZGVycz86IEh0dHBIZWFkZXJzIHwge1xuICAgICAgICBbaGVhZGVyOiBzdHJpbmddOiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgICAgIH07XG4gICAgICByZXBvcnRQcm9ncmVzcz86IGJvb2xlYW47XG4gICAgICBvYnNlcnZlOiAnYm9keSc7XG4gICAgICBwYXJhbXM/OiBIdHRwUGFyYW1zIHwge1xuICAgICAgICBbcGFyYW06IHN0cmluZ106IHN0cmluZyB8IHN0cmluZ1tdO1xuICAgICAgfTtcbiAgICAgIHJlc3BvbnNlVHlwZT86ICdhcnJheWJ1ZmZlcicgfCAnYmxvYicgfCAnanNvbicgfCAndGV4dCc7XG4gICAgICB3aXRoQ3JlZGVudGlhbHM/OiBib29sZWFuO1xuICAgIH07XG4gICAgbGV0IG1ldGhvZDogUmVxdWVzdE1ldGhvZFR5cGU7XG5cbiAgICAvLyDmoLnmja7or7fmsYLlj4LmlbDnsbvlnoss5Yid5aeL5YyW6K+35rGC5Z+65pys5L+h5oGvXG4gICAgaWYgKGFyZzAgaW5zdGFuY2VvZiBIdHRwUmVxdWVzdCkge1xuICAgICAgbWV0aG9kID0gYXJnMC5tZXRob2QudG9VcHBlckNhc2UoKSBhcyBSZXF1ZXN0TWV0aG9kVHlwZTtcbiAgICAgIHVybCA9IGFyZzAudXJsO1xuICAgICAgb3B0aW9ucyA9IHtcbiAgICAgICAgYm9keTogYXJnMC5ib2R5LFxuICAgICAgICBoZWFkZXJzOiBhcmcwLmhlYWRlcnMsXG4gICAgICAgIHJlcG9ydFByb2dyZXNzOiBhcmcwLnJlcG9ydFByb2dyZXNzLFxuICAgICAgICBvYnNlcnZlOiAnYm9keScsXG4gICAgICAgIHBhcmFtczogYXJnMC5wYXJhbXMsXG4gICAgICAgIHJlc3BvbnNlVHlwZTogYXJnMC5yZXNwb25zZVR5cGUsXG4gICAgICAgIHdpdGhDcmVkZW50aWFsczogYXJnMC53aXRoQ3JlZGVudGlhbHNcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIG1ldGhvZCA9IGFyZzA7XG4gICAgICB1cmwgPSBhcmdzWzBdO1xuICAgICAgb3B0aW9ucyA9IGFyZ3NbMV07XG4gICAgfVxuXG4gICAgLy8g5qC55o2u6K+35rGC5pWw5o2uLOafpeaJvuazqOWGjOeahEFQSVxuICAgIGNvbnN0IGtleXMgPSBbXTtcbiAgICBsZXQgcmVxdWVzdEhhbmRsZXIgPSBudWxsIGFzIFJlcXVlc3RIYW5kbGVyPFI+IHwgUjtcbiAgICBsZXQgdXJsTWF0Y2hlcyA9IHVuZGVmaW5lZCBhcyBBcnJheTxzdHJpbmc+O1xuICAgIGNvbnN0IHVybFJlY29yZCA9IHRoaXMucm91dGVyc1ttZXRob2RdIGFzIFJlY29yZDxSZXF1ZXN0TWV0aG9kVHlwZSwgUmVxdWVzdEhhbmRsZXI8Uj4gfCBSPjtcblxuICAgIGZvciAoY29uc3Qga2V5IGluIHVybFJlY29yZCkge1xuICAgICAgaWYgKHVybFJlY29yZC5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgIGNvbnN0IHJlZyA9IG5ldyBSZWdFeHAoYF4ke2tleX0kYCk7XG4gICAgICAgIGlmIChyZWcudGVzdCh1cmwpKSB7XG4gICAgICAgICAgdXJsTWF0Y2hlcyA9IHVybC5tYXRjaChyZWcpO1xuICAgICAgICAgIHJlcXVlc3RIYW5kbGVyID0gdXJsUmVjb3JkW2tleSBhcyBSZXF1ZXN0TWV0aG9kVHlwZV07XG4gICAgICAgICAga2V5cy5wdXNoKGtleSk7XG4gICAgICAgICAgaWYgKGtleXMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9ICd5ek1vY2tBcGkgRXJyb3I6IGNvbmZsaWN0LCBtYXRjaGVkIG11bHRpcGxlIHJvdXRlcyc7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKG1lc3NhZ2UsIG1ldGhvZCwgdXJsLCBrZXlzKTtcbiAgICAgICAgICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZTxIdHRwRXJyb3JSZXNwb25zZT4oc3Vic2NyaWJlciA9PiB7XG4gICAgICAgICAgICAgIHRoaXMuZGVsYXlIYW5kbGVyLmVycm9yKG1lc3NhZ2UsIHN1YnNjcmliZXIpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8g5pyq5om+5YiwQVBJ5YiZ5oql6ZSZXG4gICAgaWYgKGtleXMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gbmV3IE9ic2VydmFibGU8SHR0cEVycm9yUmVzcG9uc2U+KHN1YnNjcmliZXIgPT4ge1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gYHl6TW9ja0FwaSBFcnJvcjogY2FuJ3QgZmluZCBtb2NrIHJlc3VsdCBkYXRhOiBcXG5gICtcbiAgICAgICAgICBgMS4gcGxzIG1ha2Ugc3VyZSB0aGUgcmVxdWVzdCdzIHVybCAnJHt1cmx9JyBhbmQgbWV0aG9kICcke21ldGhvZH0nIGlzIHJpZ2h0LiBcXG5gICtcbiAgICAgICAgICBgMi4gcGxzIG1ha2Ugc3VyZSB5b3VyIG1vY2tBcGkgZmlsZSBoYXMgYmVlbiBhZGRlZCB0byB0aGUgbW9kdWxlIEh0dHBJbnRlcmNlcHRvci5gO1xuICAgICAgICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpO1xuICAgICAgICB0aGlzLmRlbGF5SGFuZGxlci5lcnJvcihtZXNzYWdlLCBzdWJzY3JpYmVyKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIHJlcXVlc3RIYW5kbGVy5Y+v6IO95piv5Zue6LCDLOS5n+WPr+iDveaYr+i/lOWbnuWAvC7lnKjmraTlgZrnsbvlnovnmoTliKTmlq0uXG4gICAgbGV0IHJlc3VsdCA9IG51bGwgYXMgT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8Uj4+IHwgUjtcbiAgICBpZiAodHlwZW9mIHJlcXVlc3RIYW5kbGVyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICByZXF1ZXN0SGFuZGxlciA9IHJlcXVlc3RIYW5kbGVyIGFzIFJlcXVlc3RIYW5kbGVyPFI+O1xuICAgICAgcmVzdWx0ID0gcmVxdWVzdEhhbmRsZXIodXJsTWF0Y2hlcywgb3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlcXVlc3RIYW5kbGVyID0gcmVxdWVzdEhhbmRsZXIgYXMgUjtcbiAgICAgIHJlc3VsdCA9IHJlcXVlc3RIYW5kbGVyO1xuICAgIH1cblxuICAgIC8vIOaMieacgOe7iOe7k+aenOeahOexu+Wei+WIhuWIq+i/lOWbnlxuICAgIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBPYnNlcnZhYmxlKSB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gZWxzZSBpZiAocmVzdWx0IGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlQmFzZSkge1xuICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKG9iID0+IHtcbiAgICAgICAgb2IubmV4dChyZXN1bHQpO1xuICAgICAgICBvYi5jb21wbGV0ZSgpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOS4gOiIrOaVsOaNruaXtuWKoOWFpeW7tuaXtlxuICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlPEh0dHBFdmVudDxSPj4ob2JzZXJ2YWJsZTEgPT4ge1xuICAgICAgICB0aGlzLmRlbGF5SGFuZGxlci5uZXh0KHJlc3VsdCwgb2JzZXJ2YWJsZTEpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG59XG4iXX0=